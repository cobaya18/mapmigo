<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Puerto Rico Map Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f3f4f6">

<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
* { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #ffffff;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body { display: flex; }

    
/* TOP BAR */
#topBar {
  position: fixed;
  top: 0.5rem;
  left: 0;
  right: 0;
  z-index: 11000;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  pointer-events: none;
}

#hamburgerButton,
#openListView {
  pointer-events: auto;
  border: none;
  background: rgba(15, 23, 42, 0.95);
  color: #e5e7eb;
  padding: 0.45rem 0.6rem;
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.9rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

#searchBarWrapper {
  flex: 1;
  max-width: 620px;
  display: flex;
  align-items: center;
  background: #ffffff;
  border-radius: 999px;
  padding: 0.25rem 0.35rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  pointer-events: auto;
}

#search {
  flex: 1;
  border: none;
  outline: none;
  background: transparent;
  color: #d1d5db;
  font-size: 0.95rem;
  padding: 0.4rem 0.6rem;
}

#search::placeholder { color: #6b7280; }

#searchClear,
#searchButton {
  border: none;
  background: transparent;
  width: 2rem;
  height: 2rem;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1rem;
  color: #4b5563;
  flex-shrink: 0;
}

#searchClear { display: none; }

@media (max-width: 768px) {
  #topBar {
    left: 0.5rem;
    right: 0.5rem;
    justify-content: space-between;
  }
  #searchBarWrapper {
    max-width: none;
  }
}








    

    @media (min-width: 769px) {
      
    }

    .search-results-header {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.35rem;
    }

    #searchResultsList { margin-top: 0.15rem; }

    .result-item {
      padding: 0.55rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      margin-bottom: 0.35rem;
      transition: background 0.12s ease;
    }

    .result-item:hover { background: #f9fafb; }

    
    

    
/* SIDEBAR / FILTER PANEL */


#sidebar.collapsed-desktop {
  transform: translateX(-120%);
}
.sidebar-handle {
  display: none;
}

@media (max-width: 768px) {
  

  #sidebar.open-mobile {
    transform: translateY(0);
  }

  .sidebar-handle {
    display: block;
    width: 52px;
    height: 5px;
    border-radius: 999px;
    background: #4b5563;
    margin: 0 0 0.5rem;
    align-self: center;
  }
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  gap: 0.5rem;
}

.sidebar-header-title {
  font-size: 0.9rem;
  font-weight: 500;
  color: #cbd5f5;
}

.sidebar-header-actions {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  justify-content: flex-end;
}

#infoBar {
  font-size: 0.8rem;
  color: #9ca3af;
  margin-bottom: 0.5rem;
  padding: 0.4rem 0.55rem;
  border-radius: 0.5rem;
  background: #ffffff;
  border: 1px solid #d1d5db;
}

.filter-group {
  margin-bottom: 0.8rem;
}

.filter-group h4 {
  margin: 0 0 0.35rem;
  font-size: 0.8rem;
  color: #9ca3af;
}
.cat-dot-large {
  width: 0.9rem;
  height: 0.9rem;
  border-radius: 50%;
  display: inline-block;
}

/* MAP */

#mapStyleToggle { top: 2rem !important; }
#gpsButton { bottom: 1rem !important; }

    #map {
      flex: 1;
      height: 100%;
      width: 100%;
    }

    @media (max-width: 768px) {
      #map {
        position: fixed;
        top: 3.1rem;
        left: 0;
        right: 0;
        bottom: 0;
      }
    }

    /* MAP STYLE TOGGLE */
    #mapStyleToggle {
      position: fixed;
      z-index: 11000;
      right: 0.75rem;
      top: 3.6rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #e5e7eb;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
    }

    #mapStyleToggle span.icon {
      font-size: 1rem;
    }

    #mapStyleMenu {
      position: fixed;
      right: 0.75rem;
      top: 6.0rem;
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      padding: 0.35rem;
      display: none;
      z-index: 11000;
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.7);
    }

    #mapStyleMenu.open { display: block; }

    .style-option {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.45rem;
      border-radius: 0.5rem;
      cursor: pointer;
      border: 1px solid transparent;
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .style-option span.icon {
      width: 1.2rem;
      text-align: center;
    }

    .style-option:hover {
      background: #ffffff;
    }

    .style-option.active {
      border-color: #38bdf8;
      background: #ffffff;
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.65);
    }

    /* CUSTOM MARKER PINS + HIGHLIGHT */
    .custom-marker .marker-pin {
      width: 22px;
      height: 22px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 2px solid #ffffff;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .marker-emoji {
      font-size: 13px;
      line-height: 1;
      transform: rotate(45deg);
      display: block;
    }

    .marker-highlight-ring {
      animation: markerPulse 0.8s ease-out forwards;
      transform-origin: center center;
    }

    @keyframes markerPulse {
      0% { transform: scale(0.6); opacity: 0.9; }
      70% { transform: scale(1.3); opacity: 0.4; }
      100% { transform: scale(1.6); opacity: 0; }
    }

    
#mapStyleToggle { top:2.5rem !important; }
#gpsButton { bottom:1.2rem !important; }

/* POPUPS */
    .leaflet-popup-content-wrapper {
      background: #ffffff;
      color: #e5e7eb;
      border-radius: 1rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
    }

    .leaflet-popup-content { margin: 0; }

    .popup-card {
      padding: 0.75rem;
      max-width: 280px;
    }

    .popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .popup-title {
      font-size: 1rem;
      font-weight: 600;
      color: #f9fafb;
      flex: 1;
    }

    .fav-btn {
      border: none;
      background: transparent;
      color: #64748b;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .fav-btn.fav-active { color: #f97316; }

    .popup-category {
      font-size: 0.8rem;
      margin-bottom: 0.45rem;
      color: #e5e7eb;
    }

    .popup-desc {
      font-size: 0.8rem;
      color: #cbd5f5;
      margin-bottom: 0.6rem;
    }

    .popup-card img {
      width: 100%;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .popup-button {
      display: inline-block;
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #38bdf8;
      background: #f9fafb;
      color: #e0f2fe;
      font-size: 0.78rem;
      text-decoration: none;
      font-weight: 500;
    }

    .popup-button:hover {
      background: #0ea5e9;
      color: #ffffff;
    }

    /* LIST VIEW OVERLAY */
    

    @media (min-width: 769px) {
      
    }

    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .list-header-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: #e5e7eb;
    }

    .list-header button {
      border: 1px solid #334155;
      background: #ffffff;
      color: #e5e7eb;
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    #listViewList {
      padding: 0.6rem 0.5rem 1.25rem;
    }

    .list-item {
      display: flex;
      gap: 0.55rem;
      padding: 0.55rem 0.55rem;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      margin-bottom: 0.4rem;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease;
    }

    .list-item:hover {
      background: #f9fafb;
      border-color: #1d4ed8;
    }

    .list-thumb {
      width: 60px;
      height: 60px;
      border-radius: 0.75rem;
      overflow: hidden;
      background: #ffffff;
      flex-shrink: 0;
    }

    .list-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .list-details { flex: 1; min-width: 0; }

    .list-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
      margin-bottom: 0.2rem;
    }

    .list-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: #f9fafb;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .list-fav-btn {
      border: none;
      background: transparent;
      color: #64748b;
      cursor: pointer;
      font-size: 1rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .list-fav-btn.fav-active { color: #f97316; }

    .list-meta {
      font-size: 0.76rem;
      color: #9ca3af;
      margin-bottom: 0.15rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-desc {
      font-size: 0.75rem;
      color: #9ca3af;
      max-height: 2.8em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* BOTTOM SHEET */
    .place-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ffffff;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      box-shadow: 0 -12px 25px rgba(0, 0, 0, 0.8);
      transform: translateY(110%);
      transition: transform 0.25s ease;
      z-index: 12000;
    }

    .place-sheet.visible {	transform: translateY(0); }
    .place-sheet.expanded { height: 80%; }

    @media (min-width: 769px) {
      .place-sheet { display: none; }
    }

    .sheet-handle {
      width: 52px;
      height: 5px;
      border-radius: 999px;
      background: #4b5563;
      margin: 0.4rem auto;
    }

    .place-sheet-inner {
      padding: 0.5rem 0.85rem 0.85rem;
      max-height: calc(80vh - 0.8rem);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    #sheetPreview {
      padding-bottom: 0.35rem;
      border-bottom: 1px solid #d1d5db;
    }

    .sheet-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      margin-bottom: 0.25rem;
    }

    #sheetTitle {
      font-size: 0.95rem;
      font-weight: 600;
      color: #f9fafb;
    }

    #sheetFavBtn {
      border: none;
      background: transparent;
      color: #64748b;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #sheetFavBtn.fav-active { color: #f97316; }

    #sheetMeta {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.35rem;
    }

    #sheetExpand {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #ffffff;
      color: #e5e7eb;
      font-size: 0.78rem;
      padding: 0.25rem 0.6rem;
      cursor: pointer;
    }

    #sheetDetails {
      padding-top: 0.4rem;
      overflow-y: auto;
    }

    #sheetImage {
      width: 100%;
      border-radius: 0.8rem;
      margin-bottom: 0.4rem;
      display: block;
    }

    #sheetDescription {
      font-size: 0.8rem;
      color: #cbd5f5;
      margin-bottom: 0.45rem;
    }

    #sheetMapsBtn {
      display: inline-block;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #38bdf8;
      background: #f9fafb;
      color: #e0f2fe;
      font-size: 0.8rem;
      text-decoration: none;
      font-weight: 500;
    }

    /* GPS BUTTON */
    #gpsButton {
      position: fixed;
      right: 0.9rem;
      bottom: 0.9rem;
      z-index: 11000;
      width: 2.4rem;
      height: 2.4rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.85);
    }

    #gpsButton.gps-active {
      animation: gpsPulse 1.1s ease-out infinite;
    }

    @keyframes gpsPulse {
      0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.5); }
      70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
      100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
    }

    
#topBar {background:transparent !important; border:none !important;}
#search {background:#ffffff !important; color:#000 !important; border-radius:2rem !important;
 padding:0.7rem 1rem !important; border:none !important;
 box-shadow:0px 2px 6px rgba(0,0,0,0.2) !important;
 background-image:url('data:image/svg+xml;utf8,<svg fill="gray" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
 background-repeat:no-repeat; background-size:20px; background-position:12px center; padding-left:2.8rem !important;}
#hamburgerButton {background:rgba(255,255,255,0.85) !important; color:#000 !important; border-radius:50%;}
#categoryButtons, #regionButtons {display:grid !important; grid-template-columns:repeat(2,1fr) !important; gap:0.35rem !important;}

/* SKELETON */
    .skeleton {
      background: linear-gradient(90deg, #ffffff, #d1d5db, #ffffff);
      background-size: 200% 100%;
      animation: skeleton 1.2s ease-in-out infinite;
    }

    @keyframes skeleton {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  
/* === Overrides for layout & light theme === */

/* Search bar aligned above sidebar on left */
#topBar {
  justify-content: flex-start;
  padding: 0.5rem 1rem;
}

#searchBarWrapper {
  max-width: 360px;
}

/* Floating search results aligned with search bar */


/* Move zoom controls away from sidebar/search */
.leaflet-control-zoom {
  top: 4.5rem;
  left: auto;
  right: 1rem;
}

/* Sidebar white card, buttons dark */


.filter-group h4 {
  color: #4b5563;
}

.filter-buttons {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.5rem;
}

.filter-buttons button {
  padding: 0.6rem 0.9rem;
  background: #111827;
  border: 1px solid #111827;
  border-radius: 999px;
  color: #f9fafb;
  font-size: 0.82rem;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  width: 100%;
  justify-content: flex-start;
  box-shadow: 0 4px 10px rgba(15, 23, 42, 0.4);
}

.filter-buttons button.active {
  background: #1f2937;
  border-color: #1f2937;
  box-shadow: 0 0 10px rgba(15, 23, 42, 0.6);
}

.cat-dot-large {
  width: 0.9rem;
  height: 0.9rem;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

/* Marker selection via inner pin scaling */
.marker-pin {
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.marker-pin-selected {
  transform: scale(1.2);
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.35);
}

/* === AA Soft Grey Theme (Option B) === */
body {
  background: #f5f5f5 !important;
  color: #1f2937 !important;
}



.filter-buttons button {
  background: #d4d4d8 !important;
  color: #1f2937 !important;
  border: 1px solid #c5c5c7 !important;
  border-radius: 999px !important;
}

.filter-buttons button.active {
  background: #bdbec2 !important;
  border-color: #9ca3af !important;
}

#searchBarWrapper {
  background: #ffffff !important;
  border: 1px solid #d1d5db !important;
}



.popup-card {
  background: #ffffff !important;
  border: 1px solid #d1d5db !important;
  color: #1f2937 !important;
}


    /* === FINAL AA SOFT GREY OVERRIDES === */

    /* Top bar and search: align above sidebar on left */
    #topBar {
      justify-content: flex-start;
      padding: 0.5rem 1rem;
    }
    #hamburgerButton,
    #openListView {
      background: #d4d4d8;
      color: #1f2937;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    #searchBarWrapper {
      max-width: 360px;
      background: #ffffff;
      border: 1px solid #d1d5db;
    }
    #search {
      color: #1f2937;
    }

    /* Search results container under search bar */
    
    .search-results-header {
      font-size: 0.8rem;
      color: #374151;
      margin-bottom: 0.4rem;
      padding: 0 0.15rem;
    }
    #searchResultsList { margin-top: 0.1rem; }
    .result-item {
      padding: 0.55rem 0.7rem;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      margin-bottom: 0.4rem;
      transition: background 0.12s ease, box-shadow 0.12s ease;
    }
    .result-item:hover {
      background: #f9fafb;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    
    

    /* Sidebar & panel cards */
    
    .sidebar-header-title,
    .filter-group h4,
    #infoBar {
      color: #374151;
    }
    #infoBar {
      background: #f3f4f6;
      border-color: #e5e7eb;
    }

    /* Unified pill buttons */
    .filter-buttons button,
    #openSavedView,
    #resetFiltersSidebar,
    #openListView,
    #mapStyleToggle,
    #gpsButton {
      background: #d4d4d8;
      color: #1f2937;
      border-radius: 999px;
      border: 1px solid #c5c5c7;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    .filter-buttons button.active {
      background: #bdbec2;
      border-color: #9ca3af;
    }
    .reset-filters-btn {
      background: #d4d4d8;
      color: #1f2937;
      border-radius: 999px;
      border: 1px solid #c5c5c7;
    }

    /* Popup wrapper / card unified */
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip,
    .popup-card {
      background: #e5e7eb;
      color: #1f2937;
      border-radius: 1rem;
      border: 1px solid #d1d5db;
      box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    }
    .leaflet-popup-tip-container {
      display: none;
    }
    .popup-title {
      color: #1f2937;
    }
    .popup-category {
      color: #4b5563;
    }
    .popup-desc {
      color: #374151;
    }
    .popup-button {
      border-color: #2563eb;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .popup-button:hover {
      background: #2563eb;
      color: #ffffff;
    }

    /* Marker selection inner pin scale (no disappearing markers) */
    .marker-pin {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .marker-pin-selected {
      transform: scale(1.2);
      box-shadow: 0 0 10px rgba(0,0,0,0.35);
    }

    /* Zoom controls moved away from sidebar */
    .leaflet-control-zoom {
      top: 4.5rem;
      left: auto;
      right: 1rem;
    }

/* === V2 Alignment Fixes === */

/* Top bar row equal heights */
#topBar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  justify-content: flex-start;
  padding-left: 1rem;
}
#hamburgerButton, #openListView {
  height: 56px !important;
  min-width: 56px;
  border-radius: 50px !important;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* Center search bar group */
#searchBarWrapper {
  height:56px !important;
  border-radius:50px !important;
}

/* Center search results under search bar */


/* Move Map toggle down above GPS */
#mapStyleToggle {
  position:fixed !important;
  top:auto !important;
  bottom:160px !important;
  right:1rem !important;
}
#mapStyleMenu {
  bottom:210px !important;
  top:auto !important;
  right:1rem !important;
}


/* === V3 precise overlay & sidebar alignment === */


#sidebar {
  top: 5.7rem !important;
}


/* --- CLEAN + FIXED SEARCH RESULTS OVERLAY --- */

.search-results-header { font-size:0.85rem;color:#374151;margin-bottom:0.4rem; }
.result-item { background:#fff;border:1px solid #d1d5db;border-radius:0.75rem;margin-bottom:0.45rem;padding:0.65rem 0.8rem;cursor:pointer;transition:0.12s; }
.result-item:hover { background:#f9fafb;box-shadow:0 2px 8px rgba(0,0,0,0.12); }


@media (max-width:768px){
  
}


/* === FINAL SEARCH RESULTS (RESPONSIVE) === */


@media (max-width:768px){
  
}


/* FINAL FIXED SEARCH RESULTS */
#searchResults {
  position: fixed;
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 1rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  z-index: 12000;
  padding: 0.6rem 0.6rem 0.8rem;
  display: none;
  overflow-y: auto;
  max-height: calc(100vh - 7rem);
}


#hamburgerButton, #openListView, #searchBarWrapper {
  height: 56px !important;
  border-radius: 50px !important;
}


#placesList {
  position: fixed;
  top: 0;
  right: 0;
  width: 420px;
  max-width: 100%;
  height: 100vh;
  overflow-y: auto;
  background: #ffffff;
  z-index: 15000 !important;
  box-shadow: -4px 0 20px rgba(0,0,0,0.15);
}

/* ListView overlay fix */


/* Map toggle repositioning */
#mapViewToggle {
    position: fixed !important;
    right: 1.2rem !important;
    bottom: 6.5rem !important;
    z-index: 99998 !important;
    display: flex !important;
    align-items: center !important;
    padding: 0.55rem 1rem !important;
    background: white !important;
    border-radius: 999px !important;
    border: 1px solid #ddd !important;
    box-shadow: 0 4px 14px rgba(0,0,0,0.15) !important;
}

/* Geolocation button */
#findLocationButton {
    position: fixed !important;
    right: 1.2rem !important;
    bottom: 2rem !important;
    z-index: 99999 !important;
}

/* Places list matches sidebar dimensions */


/* Places List AA + Soft Grey Styling */
#listViewOverlay 

#listViewOverlay 

#listViewOverlay 

#listViewOverlay 

#listViewOverlay .result * {
    max-width: 100% !important;
}

/* Buttons inside list view */
#listViewOverlay button {
    background: #d4d4d8 !important;
    color: #1f2937 !important;
    border-radius: 999px !important;
    border: 1px solid #c5c5c7 !important;
    padding: 0.5rem 1rem !important;
}

/* Improve list overlay container */


/* =============================
   FINAL AA SOFT GREY PALETTE FOR PLACES LIST
   ============================= */

/* List overlay background */
#listViewOverlay {
    background: #f3f4f6 !important;
}

/* Individual list cards */
#listViewOverlay .result {
    background: #e5e7eb !important;
    border-radius: 1rem !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12) !important;
    padding: 14px 16px !important;
    margin-bottom: 14px !important;
}

/* Title text */
#listViewOverlay .result-title {
    color: #1f2937 !important;
    font-weight: 700 !important;
    font-size: 1rem !important;
}

/* Meta line (category + region) */
#listViewOverlay .result-meta {
    color: #4b5563 !important;
    font-size: 0.85rem !important;
}

/* Description text */
#listViewOverlay .result-description {
    color: #374151 !important;
    font-size: 0.9rem !important;
    line-height: 1.35rem !important;
}

/* Ensure all text inside cards stays inside card width */
#listViewOverlay .result * {
    max-width: 100% !important;
}

/* Buttons inside list view */
#listViewOverlay button {
    background: #d4d4d8 !important;
    color: #1f2937 !important;
    border-radius: 999px !important;
    border: 1px solid #c5c5c7 !important;
    padding: 0.5rem 1rem !important;
}

/* Hover for cards */
#listViewOverlay .result:hover {
    background: #e5e7eb !important;
    box-shadow: 0 8px 22px rgba(0,0,0,0.16) !important;
}

/* === V17 LAYOUT RESTORE: SIDEBAR & PLACES LIST === */

/* Desktop sidebar */
#sidebar {
  position: fixed;
  left: 1rem;
  top: 5.7rem;
  width: 320px;
  max-width: calc(100% - 2rem);
  height: calc(100vh - 6.5rem);
  background: #f3f4f6;
  border-radius: 1rem;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
  padding: 0.75rem 0.85rem 0.9rem;
  overflow-y: auto;
  z-index: 10000;
  transition: transform 0.25s ease;
}

#sidebar.collapsed-desktop {
  transform: translateX(-120%);
}

/* Places list overlay */
#listViewOverlay {
  position: fixed;
  left: 1rem;
  top: 5.7rem;
  width: 320px;
  max-width: calc(100% - 2rem);
  height: calc(100vh - 6.5rem);
  background: #f3f4f6;
  border-radius: 1rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  overflow-y: auto;
  z-index: 12000;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  #sidebar {
    left: 0;
    right: 0;
    bottom: 0;
    top: auto;
    width: auto;
    max-width: none;
    height: 55%;
    border-radius: 1.25rem 1.25rem 0 0;
    padding: 0.75rem 1rem 1rem;
    transform: translateY(100%);
  }
  #sidebar.open-mobile {
    transform: translateY(0);
  }
  #listViewOverlay {
    left: 0;
    right: 0;
    top: 3.5rem;
    width: auto;
    max-width: none;
    height: calc(100vh - 3.5rem);
    border-radius: 0;
    box-shadow: none;
  }
}




#listViewOverlay.closed { display: none; }

/* === V20 TEXT CONTRAST FIX: UNIFORM DARK TEXT === */
#listViewOverlay .result-title,
#listViewOverlay .result-meta,
#listViewOverlay .result-description,
#listViewOverlay button,
#sidebar .result-title,
#sidebar .result-meta,
#sidebar .result-description,
#sidebar button {
    color: #1f2937 !important;
}

#listViewOverlay .result-description,
#sidebar .result-description {
    line-height: 1.35rem !important;
}

/* Ensure card backgrounds remain soft grey */
#listViewOverlay .result,
#sidebar .result {
    background: #e5e7eb !important;
    border: 1px solid #d1d5db !important;
}

/* Buttons maintain soft-grey pill style */
#listViewOverlay button,
#sidebar button {
    background: #d4d4d8 !important;
    border-radius: 999px !important;
    border: 1px solid #c5c5c7 !important;
}


/* === V21 TEXT HIERARCHY FIX === */

/* Titles: darkest */
#listViewOverlay .result-title,
#sidebar .result-title {
    color: #111827 !important;
    font-weight: 700 !important;
}

/* Descriptions: slightly lighter dark */
#listViewOverlay .result-description,
#sidebar .result-description {
    color: #1f2937 !important;
    line-height: 1.35rem !important;
}

/* Meta text: medium-dark */
#listViewOverlay .result-meta,
#sidebar .result-meta {
    color: #374151 !important;
}

/* Buttons still readable on grey */
#listViewOverlay button,
#sidebar button {
    background: #d4d4d8 !important;
    color: #1f2937 !important;
    border-radius: 999px !important;
    border: 1px solid #c5c5c7 !important;
}


/* === V22 CONTRAST FIX: REMOVE FADED TEXT IN PLACES LIST + MAP STYLE MENU === */

/* Fix faded text inside Places List */
#listViewOverlay *,
#listViewOverlay .result *,
#listViewOverlay .result-title,
#listViewOverlay .result-description,
#listViewOverlay .result-meta {
    opacity: 1 !important;
    filter: none !important;
}

/* Ensure Places List backgrounds are fully opaque */
#listViewOverlay,
#listViewOverlay .result {
    background-color: rgba(255,255,255,1) !important;
}

/* Fix faded text in the Map Style toggle menu */
.map-toggle-menu span,
#mapStyleButton span,
.map-toggle-option span {
    opacity: 1 !important;
    filter: none !important;
    color: #1f2937 !important; /* AA compliant */
}


/* === V23 FIX: REMOVE BLACK TRANSPARENCY LAYER FROM PLACES LIST & MAP STYLE MENU === */

/* Remove the semi-transparent black overlay */
#listViewOverlay {
    background: #f3f4f6 !important;
    background-color: #f3f4f6 !important;
}

/* Remove any inherited transparency from children */
#listViewOverlay * {
    background-color: transparent !important;
    opacity: 1 !important;
    filter: none !important;
}

/* Ensure result cards stay correct */
#listViewOverlay .result {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
}

/* Fix Map Style toggle menu transparency */
.map-toggle-menu,
.map-toggle-option {
    background: #f3f4f6 !important;
    background-color: #f3f4f6 !important;
}

/* Ensure Map Style menu text is crisp */
.map-toggle-menu span,
.map-toggle-option span,
#mapStyleButton span {
    opacity: 1 !important;
    filter: none !important;
    color: #1f2937 !important;
}


/* === Places List Text Contrast Upgrade === */
#listViewOverlay,
#listViewOverlay * {
    color: #111827 !important; /* deep grey-black for AA */
}

#listViewOverlay .place-title {
    font-weight: 600 !important;
    color: #111827 !important;
}

#listViewOverlay .place-description,
#listViewOverlay .place-meta {
    color: #4B5563 !important; /* softer grey */
}

#listViewOverlay .list-item,
#listViewOverlay .placeCard,
#listViewOverlay .place-card {
    background: #F3F4F6 !important;  /* soft grey consistent with UI */
    border: 1px solid #E5E7EB !important;
    border-radius: 14px !important;
}


/* === Map Style Toggle Placement Upgrade === */

/* GPS button (Find My Location) */
#gpsButton {
    position: fixed !important;
    bottom: 1rem !important;
    right: 1rem !important;
    z-index: 12000 !important;
}

/* Map Style Toggle above GPS button */
#mapStyleToggle {
    position: fixed !important;
    bottom: calc(1rem + 55px) !important;
    right: 1rem !important;
    z-index: 12000 !important;
}

/* Map style menu stays aligned next to the toggle */
#mapStyleMenu {
    position: fixed !important;
    bottom: calc(1rem + 55px + 48px) !important;
    right: 1rem !important;
    z-index: 12000 !important;
}


/* === Map Toggle Menu Text Contrast Fix === */
#mapStyleMenu,
#mapStyleMenu * {
    color: #111827 !important;       /* strong AA-compliant text */
}

#mapStyleMenu .option,
#mapStyleMenu .map-toggle-option {
    background: #F3F4F6 !important;  /* soft grey background */
    border: 1px solid #E5E7EB !important;
    border-radius: 10px !important;
    padding: 6px 10px !important;
}

#mapStyleToggle span {
    color: #111827 !important;
}

</style></head>
<body>
  <div id="topBar">
  <button id="hamburgerButton" aria-label="Toggle filters">‚ò∞</button>

  <div id="searchBarWrapper">
    <input
      id="search"
      placeholder="Search places‚Ä¶"
      aria-label="Search places"
    />
    <button id="searchClear" aria-label="Clear search">‚úï</button>
    <button id="searchButton" aria-label="Search">üîç</button>
  </div>

  <button id="openListView" aria-label="Open list view">List</button>
</div>

  <div id="searchResults">
    <div class="search-results-header">Search results</div>
    <div id="searchResultsList"></div>
  </div>

  <div id="sidebar">
  <div class="sidebar-handle"></div>

  <div class="sidebar-header">
    <div class="sidebar-header-title">Filters</div>
    <div class="sidebar-header-actions">
      <button id="openSavedView">Saved</button>
    </div>
  </div>

  <div id="infoBar">Loading places‚Ä¶</div>

  <div class="filter-group">
    <h4>Filter by Category</h4>
    <div id="categoryButtons" class="filter-buttons"></div>
  </div>

  <div class="filter-group">
    <h4>Filter by Region</h4>
    <div id="regionButtons" class="filter-buttons"></div>
  </div>

  <div class="filter-group filter-group-reset">
    <button id="resetFiltersSidebar" class="reset-filters-btn">
      Reset filters
    </button>
  </div>
</div>

<div id="map"></div>

  <button id="mapStyleToggle">
    <span class="icon">üõ∞Ô∏è</span>
    <span>Map</span>
  </button>
  <div id="mapStyleMenu">
    <button class="style-option active" data-theme="Satellite">
      <span class="icon">üõ∞Ô∏è</span><span>Satellite</span>
    </button>
    <button class="style-option" data-theme="Dark">
      <span class="icon">‚¨õ</span><span>Dark</span>
    </button>
    <button class="style-option" data-theme="Light">
      <span class="icon">‚óªÔ∏è</span><span>Light</span>
    </button>
  </div>

  <button id="gpsButton" title="Find my location">üìç</button>

  <div id="listViewOverlay" class="closed">
    <div class="list-header">
      <div id="listHeaderTitle" class="list-header-title">Places list</div>
      <button id="closeListView">Close</button>
    </div>
    <div id="listViewList"></div>
  </div>

  <div id="placeSheet" class="place-sheet">
    <div class="sheet-handle"></div>
    <div class="place-sheet-inner">
      <div id="sheetPreview">
        <div class="sheet-title-row">
          <div id="sheetTitle"></div>
          <button id="sheetFavBtn">‚ô°</button>
        </div>
        <div id="sheetMeta"></div>
        <button id="sheetExpand">Expand</button>
      </div>
      <div id="sheetDetails">
        <img id="sheetImage" alt="" />
        <p id="sheetDescription"></p>
        <a id="sheetMapsBtn" target="_blank" href="#">Open in Google Maps</a>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map("map").setView([18.2208, -66.5901], 9);

    const baseLayers = {
      Satellite: L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { attribution: "Tiles &copy; Esri" }
      ),
      Dark: L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        { attribution: "&copy; OpenStreetMap, &copy; CartoDB" }
      ),
      Light: L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { attribution: "&copy; OpenStreetMap contributors" }
      )
    };

    let currentBase = null;

    function setBaseMap(theme) {
      const layer = baseLayers[theme] || baseLayers.Satellite;
      if (currentBase && map.hasLayer(currentBase)) {
        map.removeLayer(currentBase);
      }
      currentBase = layer;
      currentBase.addTo(map);
    }
    setBaseMap("Satellite");

    const mapStyleToggle = document.getElementById("mapStyleToggle");
    const mapStyleMenu = document.getElementById("mapStyleMenu");

    mapStyleToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      mapStyleMenu.classList.toggle("open");
    });

    document.addEventListener("click", () => {
      mapStyleMenu.classList.remove("open");
    });

    document.querySelectorAll(".style-option").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const theme = btn.dataset.theme;
        setBaseMap(theme);

        document
          .querySelectorAll(".style-option")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const iconSpan = mapStyleToggle.querySelector(".icon");
        if (theme === "Satellite") iconSpan.textContent = "üõ∞Ô∏è";
        else if (theme === "Dark") iconSpan.textContent = "‚¨õ";
        else iconSpan.textContent = "‚óªÔ∏è";

        mapStyleMenu.classList.remove("open");
      });
    });

    let clusterGroup = L.markerClusterGroup({
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      spiderfyOnEveryClick: true,
      animateAddingMarkers: true,
      disableClusteringAtZoom: 10,
      maxClusterRadius: 50,
      spiderfyDistanceMultiplier: 1.4,
    });
    map.addLayer(clusterGroup);

    const FAVORITES_KEY = "pr_map_favorites_v1";
    let favoriteSet = new Set();

    function loadFavorites() {
      try {
        const raw = localStorage.getItem(FAVORITES_KEY);
        if (raw) {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) favoriteSet = new Set(arr);
        }
      } catch (e) { console.warn("Failed to load favorites", e); }
    }

    function saveFavorites() {
      try {
        localStorage.setItem(FAVORITES_KEY, JSON.stringify([...favoriteSet]));
      } catch (e) { console.warn("Failed to save favorites", e); }
    }

    function getPlaceKey(place, index) {
      if (place.id) return "id:" + place.id;
      if (place.slug) return "slug:" + place.slug;
      return "idx:" + index + ":" + (place.title || "");
    }

    function isFavorite(key) { return favoriteSet.has(key); }
    function toggleFavorite(key) {
      if (favoriteSet.has(key)) favoriteSet.delete(key);
      else favoriteSet.add(key);
      saveFavorites();
    }

    function getCategoryColor(c = "") {
      const byExact = {
        "Beach": "#00C8FF",
        "Entertainment": "#FF0080",
        "Food": "#FF6B00",
        "Hiking": "#2DD4BF",
        "Historical Landmark": "#8B5CF6",
        "Museum": "#3F51B5",
        "Nightlife": "#FF1493",
        "Park/Nature": "#4CAF50",
        "Point of Interest": "#FFD400",
        "River/Waterfall": "#0096C7",
        "Shopping": "#FFB703",
        "Tour/Activity": "#3B82F6",
        "Viewpoint": "#E11D48"
      };
      if (byExact[c]) return byExact[c];
      const n = c.toLowerCase();
      if (n.includes("beach")) return "#00C8FF";
      if (n.includes("night")) return "#FF1493";
      if (n.includes("food") || n.includes("restaurant")) return "#FF6B00";
      if (n.includes("park") || n.includes("nature")) return "#4CAF50";
      if (n.includes("hike")) return "#2DD4BF";
      if (n.includes("view")) return "#E11D48";
      if (n.includes("museum")) return "#3F51B5";
      if (n.includes("historic") || n.includes("landmark")) return "#8B5CF6";
      if (n.includes("shop")) return "#FFB703";
      if (n.includes("entertainment")) return "#FF0080";
      if (n.includes("guided") || n.includes("tour") || n.includes("activity")) return "#3B82F6";
      if (n.includes("water") || n.includes("river") || n.includes("falls")) return "#0096C7";
      if (n.includes("point")) return "#FFD400";
      return "#3B82F6";
    }

    const categoryEmojiMap = {
      "Beach": "üèñÔ∏è",
      "Entertainment": "üéüÔ∏è",
      "Food": "üçΩÔ∏è",
      "Hiking": "ü•æ",
      "Historical Landmark": "üè∞",
      "Museum": "üèõÔ∏è",
      "Nightlife": "üéµ",
      "Park/Nature": "üå≥",
      "Point of Interest": "üìç",
      "River/Waterfall": "üèûÔ∏è",
      "Shopping": "üõçÔ∏è",
      "Tour/Activity": "üß≠",
      "Viewpoint": "üì∏"
    };

    function getCategoryEmoji(c = "") {
      if (categoryEmojiMap[c]) return categoryEmojiMap[c];
      const n = c.toLowerCase();
      if (n.includes("beach")) return "üèñÔ∏è";
      if (n.includes("night")) return "üéµ";
      if (n.includes("food") || n.includes("restaurant")) return "üçΩÔ∏è";
      if (n.includes("park") || n.includes("nature")) return "üå≥";
      if (n.includes("hike")) return "ü•æ";
      if (n.includes("view")) return "üì∏";
      if (n.includes("museum")) return "üèõÔ∏è";
      if (n.includes("historic") || n.includes("landmark")) return "üè∞";
      if (n.includes("shop")) return "üõçÔ∏è";
      if (n.includes("entertainment")) return "üéüÔ∏è";
      if (n.includes("tour") || n.includes("activity")) return "üß≠";
      if (n.includes("water") || n.includes("river") || n.includes("falls")) return "üèûÔ∏è";
      if (n.includes("point")) return "üìç";
      return "üìç";
    }

    function normalize(str = "") {
      return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[ÃÄ-ÕØ]/g, "")
        .replace(/[^a-z0-9]/g, "");
    }

    function softMatch(text, q) {
      if (!q.trim()) return true;
      return normalize(text || "").includes(normalize(q));
    }

    function relevanceScore(place, q) {
      if (!q.trim()) return 0;
      const nq = normalize(q);
      const nt = normalize(place.title || "");
      let s = 0;
      if (softMatch(place.title, q)) s += 10;
      if (softMatch(place.category, q)) s += 3;
      if (softMatch(place.region, q)) s += 2;
      if (softMatch(place.description, q)) s += 1;
      if (nt.startsWith(nq)) s += 6;
      if (nt === nq) s += 4;
      return s;
    }

    function populateFilters(places) {
      const cats = [...new Set(places.map(p => p.category))].filter(Boolean).sort();
      const regs = [...new Set(places.map(p => p.region))].filter(Boolean).sort();

      const catDiv = document.getElementById("categoryButtons");
      const regDiv = document.getElementById("regionButtons");

      catDiv.innerHTML = '<button data-value="all" class="active">All</button>';
      cats.forEach(c => {
        const col = getCategoryColor(c);
        catDiv.innerHTML += `<button data-value="${c}"><span class="cat-dot-large" style="background:${col};"></span>${c}</button>`;
      });

      regDiv.innerHTML = '<button data-value="all" class="active">All</button>';
      regs.forEach(r => {
        regDiv.innerHTML += `<button data-value="${r}">${r}</button>`;
      });

      setupMultiSelect(catDiv);
      setupMultiSelect(regDiv);
    }

    function setupMultiSelect(container) {
      container.querySelectorAll("button").forEach(btn => {
        btn.onclick = () => {
          if (btn.dataset.value === "all") {
            container.querySelectorAll("button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          } else {
            btn.classList.toggle("active");
            container.querySelector('[data-value="all"]').classList.remove("active");
            const anySelected = [...container.querySelectorAll("button")].some(
              b => b.dataset.value !== "all" && b.classList.contains("active")
            );
            if (!anySelected) {
              container.querySelector('[data-value="all"]').classList.add("active");
            }
          }
          applyFilters();
        };
      });
    }

    function createMarkerIcon(category) {
      const color = getCategoryColor(category);
      const emoji = getCategoryEmoji(category);

      return L.divIcon({
        className: "custom-marker",
        html: `
          <div class="marker-pin" style="background:${color}">
            <span class="marker-emoji">${emoji}</span>
          </div>
        `,
        iconSize: [26, 36],
        iconAnchor: [13, 34],
        popupAnchor: [0, -32],
      });
    }

    let globalPlaces = [];
    let markers = [];
    let currentVisible = [];
    let highlightRing = null;

    function highlightMarker(marker) {
      if (!marker) return;
      if (highlightRing) {
        map.removeLayer(highlightRing);
        highlightRing = null;
      }
      highlightRing = L.circleMarker(marker.getLatLng(), {
        radius: 18,
        color: "#38BDF8",
        weight: 2,
        fillOpacity: 0,
        className: "marker-highlight-ring",
      }).addTo(map);

      setTimeout(() => {
        if (highlightRing) {
          map.removeLayer(highlightRing);
          highlightRing = null;
        }
      }, 800);
    }

    function createMarkers(places) {
      markers = [];
      clusterGroup.clearLayers();

      places.forEach((p, index) => {
        const lat = Number(p.latitude);
        const lng = Number(p.longitude);
        if (!lat || !lng) {
          markers.push(null);
          return;
        }

        const marker = L.marker([lat, lng], {
          icon: createMarkerIcon(p.category),
        });

        const key = getPlaceKey(p, index);
        const url =
          p.google_maps_url || p.map_url || p.maps_url || p.google_url || null;

        let html = "<div class='popup-card'>";
        html += `<div class="popup-header">
          <div class="popup-title">${p.title || ""}</div>
          <button class="fav-btn ${isFavorite(key) ? "fav-active" : ""}" data-key="${key}">‚ô°</button>
        </div>`;
        if (p.category) {
          html += `<div class="popup-category">${p.category}</div>`;
        }
        if (p.image_url) {
          html += `<div class="popup-image-wrapper skeleton">
            <img loading="lazy" src="${p.image_url}" class="skeleton" onload="this.classList.remove('skeleton'); this.parentElement.classList.remove('skeleton');" />
          </div>`;
        }
        if (p.description) {
          html += `<div class="popup-desc">${p.description}</div>`;
        }
        if (url) {
          html += `<a class="popup-button" target="_blank" href="${url}">Open in Google Maps</a>`;
        }
        html += "</div>";

        marker.bindPopup(html);

        marker.on("click", () => {
          highlightMarker(marker);
          if (window.innerWidth <= 768) {
            showPlaceSheet(p, key, index);
          } else {
            marker.openPopup();
          }
        });

        marker.on("popupopen", (e) => {
          const popupNode = e.popup._contentNode;
          const favBtn = popupNode.querySelector(".fav-btn");
          if (favBtn) {
            favBtn.onclick = (evt) => {
              evt.stopPropagation();
              const k = favBtn.dataset.key;
              toggleFavorite(k);
              if (isFavorite(k)) favBtn.classList.add("fav-active");
              else favBtn.classList.remove("fav-active");
            };
          }
        });

        
marker.on('click', () => {
          document.querySelectorAll('.marker-pin').forEach(p => p.classList.remove('marker-pin-selected'));
          const el = marker._icon;
          if (el) {
            const pin = el.querySelector('.marker-pin');
            if (pin) pin.classList.add('marker-pin-selected');
          }
        });

        clusterGroup.addLayer(marker);
        markers.push(marker);
      });
    }

    function updateInfoBar(visibleCount, activeCats, activeRegs) {
      const infoBar = document.getElementById("infoBar");
      const parts = [];
      parts.push(visibleCount === 1 ? "1 result" : `${visibleCount} results`);

      const filterBits = [];
      if (activeCats.length > 0) filterBits.push("Categories: " + activeCats.join(", "));
      if (activeRegs.length > 0) filterBits.push("Regions: " + activeRegs.join(", "));
      if (filterBits.length > 0) parts.push("Filters: " + filterBits.join(" ‚Ä¢ "));
      else parts.push("No filters active");

      infoBar.textContent = parts.join(" ‚Ä¢ ");
    }

    const placeSheet = document.getElementById("placeSheet");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetMeta = document.getElementById("sheetMeta");
    const sheetExpand = document.getElementById("sheetExpand");
    const sheetDetails = document.getElementById("sheetDetails");
    const sheetImage = document.getElementById("sheetImage");
    const sheetDesc = document.getElementById("sheetDescription");
    const sheetMapsBtn = document.getElementById("sheetMapsBtn");
    const sheetHandle = document.querySelector(".sheet-handle");
    const sheetPreview = document.getElementById("sheetPreview");
    const sheetFavBtn = document.getElementById("sheetFavBtn");
    sheetImage.loading = "lazy";

    let currentSheetKey = null;

    function showPlaceSheet(place, key, index) {
      placeSheet.classList.add("visible");
      placeSheet.classList.remove("expanded");
      placeSheet.style.transition = "transform 0.25s ease";
      placeSheet.style.transform = "";
      currentSheetKey = key;

      sheetTitle.textContent = place.title || "";
      sheetMeta.textContent = [place.category, place.region].filter(Boolean).join(" ‚Ä¢ ");
      sheetDesc.textContent = place.description || "";

      if (place.image_url) {
        sheetImage.style.display = "block";
        sheetImage.classList.add("skeleton");
        sheetImage.onload = () => sheetImage.classList.remove("skeleton");
        sheetImage.src = place.image_url;
      } else {
        sheetImage.style.display = "none";
      }

      const url =
        place.google_maps_url || place.map_url || place.maps_url || place.google_url || null;
      if (url) {
        sheetMapsBtn.href = url;
        sheetMapsBtn.style.display = "inline-block";
      } else {
        sheetMapsBtn.style.display = "none";
      }

      if (isFavorite(key)) sheetFavBtn.classList.add("fav-active");
      else sheetFavBtn.classList.remove("fav-active");
    }

    sheetExpand.addEventListener("click", () => {
      placeSheet.classList.add("expanded");
    });

    sheetFavBtn.addEventListener("click", () => {
      if (!currentSheetKey) return;
      toggleFavorite(currentSheetKey);
      if (isFavorite(currentSheetKey)) sheetFavBtn.classList.add("fav-active");
      else sheetFavBtn.classList.remove("fav-active");
    });

    let dragStartY = null;
    let currentY = null;
    let dragging = false;

    function sheetTouchStart(e) {
      if (window.innerWidth > 768) return;
      if (e.touches.length !== 1) return;
      dragging = true;
      dragStartY = e.touches[0].clientY;
      currentY = dragStartY;
      placeSheet.style.transition = "none";
    }

    function sheetTouchMove(e) {
      if (!dragging) return;
      currentY = e.touches[0].clientY;
      const delta = currentY - dragStartY;
      if (delta > 0) {
        placeSheet.style.transform = `translateY(${delta}px)`;
      }
    }

    function sheetTouchEnd() {
      if (!dragging) return;
      dragging = false;
      placeSheet.style.transition = "transform 0.25s ease";
      const delta = (currentY || dragStartY) - dragStartY;

      if (delta > 80) {
        placeSheet.classList.remove("visible");
        placeSheet.classList.remove("expanded");
        placeSheet.style.transform = "";
      } else {
        placeSheet.style.transform = "";
      }

      dragStartY = null;
      currentY = null;
    }

    [sheetHandle, sheetPreview].forEach(el => {
      el.addEventListener("touchstart", sheetTouchStart, { passive: true });
      el.addEventListener("touchmove", sheetTouchMove, { passive: true });
      el.addEventListener("touchend", sheetTouchEnd);
      el.addEventListener("touchcancel", sheetTouchEnd);
    });

    function renderSearchResults(items, q) {
      const overlay = document.getElementById("searchResults");
      const list = document.getElementById("searchResultsList");

      if (!q.trim() || items.length === 0) {
        overlay.style.display = "none";
        list.innerHTML = "";
        return;
      }

      const scored = items
        .map(({ place, index }) => ({
          place,
          index,
          score: relevanceScore(place, q),
        }))
        .filter(x => x.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 5);

      if (scored.length === 0) {
        overlay.style.display = "none";
        list.innerHTML = "";
        return;
      }

      list.innerHTML = "";
      scored.forEach(({ place, index }) => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
          <div class="result-title">${place.title}</div>
          <div class="result-meta">${(place.category || "")} ‚Ä¢ ${(place.region || "")}</div>
        `;
        div.onclick = () => {
          const m = markers[index];
          if (!m) return;
          map.setView(m.getLatLng(), 14);
          highlightMarker(m);
          if (window.innerWidth <= 768) {
            const key = getPlaceKey(place, index);
            showPlaceSheet(place, key, index);
          } else {
            m.fire("click");
          }
        };
        list.appendChild(div);
      });

      overlay.style.display = "block";
    }

    const listViewOverlay = document.getElementById("listViewOverlay");
    const listViewList = document.getElementById("listViewList");
    const openListViewBtn = document.getElementById("openListView");
    const closeListViewBtn = document.getElementById("closeListView");
    const openSavedViewBtn = document.getElementById("openSavedView");
    const listHeaderTitleEl = document.getElementById("listHeaderTitle");

    function renderListView(items, mode = "all") {
      const sorted = [...items].sort((a, b) =>
        (a.place.title || "").localeCompare(b.place.title || "", "en", { sensitivity: "base" })
      );

      listViewList.innerHTML = "";

      if (mode === "saved" && sorted.length === 0) {
        const empty = document.createElement("div");
        empty.style.padding = "0.75rem";
        empty.style.fontSize = "0.85rem";
        empty.style.color = "#9ca3af";
        empty.textContent = "You haven‚Äôt saved any places yet. Tap the ‚ô° icon on a place to save it.";
        listViewList.appendChild(empty);
      }

      sorted.forEach(({ place, index }) => {
        const key = getPlaceKey(place, index);
        const div = document.createElement("div");
        div.className = "list-item";

        const thumb = document.createElement("div");
        thumb.className = "list-thumb skeleton";

        const img = document.createElement("img");
        if (place.image_url) {
          img.loading = "lazy";
          img.classList.add("skeleton");
          img.onload = () => {
            img.classList.remove("skeleton");
            thumb.classList.remove("skeleton");
          };
          img.src = place.image_url;
        } else {
          thumb.classList.remove("skeleton");
        }
        thumb.appendChild(img);

        const details = document.createElement("div");
        details.className = "list-details";

        const titleRow = document.createElement("div");
        titleRow.className = "list-title-row";

        const titleEl = document.createElement("div");
        titleEl.className = "list-title";
        titleEl.textContent = place.title || "";

        const favBtn = document.createElement("button");
        favBtn.className = "list-fav-btn";
        if (isFavorite(key)) favBtn.classList.add("fav-active");
        favBtn.textContent = "‚ô°";
        favBtn.onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(key);
          if (isFavorite(key)) favBtn.classList.add("fav-active");
          else favBtn.classList.remove("fav-active");
        };

        titleRow.appendChild(titleEl);
        titleRow.appendChild(favBtn);

        const metaEl = document.createElement("div");
        metaEl.className = "list-meta";
        metaEl.textContent = [place.category, place.region].filter(Boolean).join(" ‚Ä¢ ");

        const descEl = document.createElement("div");
        descEl.className = "list-desc";
        descEl.textContent = place.description || "";

        details.appendChild(titleRow);
        details.appendChild(metaEl);
        details.appendChild(descEl);

        div.appendChild(thumb);
        div.appendChild(details);

        div.onclick = () => {
          const m = markers[index];
          if (!m) return;
          map.setView(m.getLatLng(), 14);
          highlightMarker(m);
          if (window.innerWidth <= 768) {
            showPlaceSheet(place, key, index);
          } else {
            m.fire("click");
          }
        };

        listViewList.appendChild(div);
      });

      if (listHeaderTitleEl) {
        listHeaderTitleEl.textContent =
          mode === "saved" ? "Saved places" : "Places list";
      }
    }

    function openListView() {
      renderListView(currentVisible, "all");
      listViewOverlay.style.display = "block";
    }

    function openSavedView() {
      const saved = [];
      globalPlaces.forEach((place, index) => {
        const key = getPlaceKey(place, index);
        if (favoriteSet.has(key)) {
          saved.push({ place, index });
        }
      });
      renderListView(saved, "saved");
      listViewOverlay.style.display = "block";
    }

    function closeListView() {
      listViewOverlay.style.display = "none";
    }

    if (openListViewBtn) openListViewBtn.onclick = openListView;
    if (closeListViewBtn) closeListViewBtn.onclick = closeListView;
    if (openSavedViewBtn) openSavedViewBtn.onclick = openSavedView;

    function applyFilters() {
      const q = document.getElementById("search").value || "";

      const activeCats = [...document.querySelectorAll("#categoryButtons button.active")]
        .map(b => b.dataset.value)
        .filter(v => v !== "all");

      const activeRegs = [...document.querySelectorAll("#regionButtons button.active")]
        .map(b => b.dataset.value)
        .filter(v => v !== "all");

      let bounds = null;
      const visible = [];

      globalPlaces.forEach((p, i) => {
        const m = markers[i];
        if (!m) return;

        const inCat = activeCats.length === 0 || activeCats.includes(p.category);
        const inReg = activeRegs.length === 0 || activeRegs.includes(p.region);
        const inSearch =
          !q.trim() ||
          softMatch(p.title, q) ||
          softMatch(p.description, q) ||
          softMatch(p.category, q) ||
          softMatch(p.region, q);

        const show = inCat && inReg && inSearch;

        if (!show) {
          if (clusterGroup.hasLayer(m)) clusterGroup.removeLayer(m);
        } else {
          if (!clusterGroup.hasLayer(m)) clusterGroup.addLayer(m);
          const ll = m.getLatLng();
          if (!bounds) bounds = L.latLngBounds(ll, ll);
          else bounds.extend(ll);
          visible.push({ place: p, index: i });
        }
      });

      visible.sort((a, b) =>
        (a.place.title || "").localeCompare(b.place.title || "", "en", { sensitivity: "base" })
      );
      currentVisible = visible;

      if (visible.length > 0 && bounds && !q.trim()) {
        map.fitBounds(bounds.pad(0.2));
      } else if (visible.length === 0) {
        map.setView([18.2208, -66.5901], 9);
      }

      renderSearchResults(visible, q);
      updateInfoBar(visible.length, activeCats, activeRegs);
    }

    const searchInput = document.getElementById("search");
const searchClearBtn = document.getElementById("searchClear");
const searchButton = document.getElementById("searchButton");

if (searchInput) {
  searchInput.addEventListener("input", () => {
    const hasText = searchInput.value.trim().length > 0;
    if (searchClearBtn) {
      searchClearBtn.style.display = hasText ? "flex" : "none";
    }
    applyFilters();
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      applyFilters();
    }
  });
}

if (searchClearBtn) {
  searchClearBtn.addEventListener("click", () => {
    searchInput.value = "";
    searchClearBtn.style.display = "none";
    applyFilters();
    const sr = document.getElementById("searchResults");
    if (sr) sr.style.display = "none";
  });
}

if (searchButton) {
  searchButton.addEventListener("click", () => {
    applyFilters();
  });
}

    function resetFilters() {
      document.getElementById("search").value = "";
      ["categoryButtons", "regionButtons"].forEach(id => {
        const div = document.getElementById(id);
        div.querySelectorAll("button").forEach(b => b.classList.remove("active"));
        const allBtn = div.querySelector('[data-value="all"]');
        if (allBtn) allBtn.classList.add("active");
      });
      applyFilters();
    }

    const resetSidebarBtn = document.getElementById("resetFiltersSidebar");
    if (resetSidebarBtn) resetSidebarBtn.onclick = resetFilters;

    document.getElementById("hamburgerButton").onclick = () => {
  const sidebar = document.getElementById("sidebar");
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle("open-mobile");
  } else {
    sidebar.classList.toggle("collapsed-desktop");
  }
};

    const gpsButton = document.getElementById("gpsButton");
    let userLocationMarker = null;

    gpsButton.addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }
      gpsButton.classList.add("gps-active");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          gpsButton.classList.remove("gps-active");
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (!userLocationMarker) {
            userLocationMarker = L.circleMarker([lat, lng], {
              radius: 8,
              fillColor: "#3B82F6",
              fillOpacity: 1,
              color: "#93C5FD",
              weight: 3
            }).addTo(map);
          } else {
            userLocationMarker.setLatLng([lat, lng]);
          }

          map.setView([lat, lng], 13);
        },
        (err) => {
          gpsButton.classList.remove("gps-active");
          console.warn("Geolocation error", err);
          alert("Unable to get your location.");
        },
        { enableHighAccuracy: true, timeout: 8000 }
      );
    });

    async function loadPlaces() {
      try {
        const res = await fetch(
          "https://puerto-rico-map.cobaya18.workers.dev/places"
        );
        globalPlaces = await res.json();
        loadFavorites();
        populateFilters(globalPlaces);
        createMarkers(globalPlaces);
        applyFilters();
      } catch (e) {
        console.error("Failed to load places", e);
        document.getElementById("infoBar").textContent =
          "Error loading places.";
      }
    }

    loadPlaces();
  </script>
<script>
function positionSearchResults() {
    const bar = document.getElementById("searchBarWrapper");
    const results = document.getElementById("searchResults");
    if (!bar || !results) return;
    const rect = bar.getBoundingClientRect();
    results.style.left = rect.left + "px";
    results.style.width = rect.width + "px";
    results.style.top = (rect.bottom + 8) + "px";
}
window.addEventListener("resize", positionSearchResults);
window.addEventListener("DOMContentLoaded", positionSearchResults);
</script><script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker
      .register("service-worker.js")
      .then(function () {
        console.log("Service Worker registered for Puerto Rico Map Guide");
      })
      .catch(function (err) {
        console.warn("Service Worker registration failed:", err);
      });
  });
}
</script>
</body>
</html>
